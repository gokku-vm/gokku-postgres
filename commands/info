#!/bin/bash
SERVICE_NAME="$1"

echo "PostgreSQL Service: $SERVICE_NAME"
echo "============================="

# Source helper functions
source /opt/gokku/scripts/plugin-helpers.sh

# Check if container exists
if ! container_exists "$SERVICE_NAME"; then
    echo "Status: NOT FOUND"
    exit 0
fi

# Check if container is running
if ! container_is_running "$SERVICE_NAME"; then
    echo "Status: STOPPED"
    exit 0
fi

# Get service information
STATUS=$(get_container_status "$SERVICE_NAME")
PORT=$(get_container_port "$SERVICE_NAME" 5432)
UPTIME=$(get_container_uptime "$SERVICE_NAME")

# Parse service config using jq
SERVICE_CONFIG=$(get_service_config "$SERVICE_NAME")
CONFIG_DIR=$(echo "$SERVICE_CONFIG" | jq -r '.config.config_dir // empty')
DATA_VOLUME=$(echo "$SERVICE_CONFIG" | jq -r '.config.data_volume // empty')
POSTGRES_USER=$(echo "$SERVICE_CONFIG" | jq -r '.config.user // empty')
POSTGRES_DB=$(echo "$SERVICE_CONFIG" | jq -r '.config.database // empty')
POSTGRES_IMAGE=$(echo "$SERVICE_CONFIG" | jq -r '.config.image // empty')
POSTGRES_PASSWORD=$(echo "$SERVICE_CONFIG" | jq -r '.config.password // empty')

echo "Status: $STATUS"
echo "Port: $PORT"
echo "Uptime: $UPTIME"
echo "Image: ${POSTGRES_IMAGE:-postgres:latest}"
echo "User: $POSTGRES_USER"
echo "Database: $POSTGRES_DB"
echo "Configuration: $CONFIG_DIR"
echo "Data volume: $DATA_VOLUME"

# Get PostgreSQL-specific information
if container_is_running "$SERVICE_NAME"; then
    echo ""
    echo "PostgreSQL Information:"

    # Get PostgreSQL version
    PG_VERSION=$(docker exec "$SERVICE_NAME" psql --version 2>/dev/null | head -1 || echo "Unknown")
    echo "Version: $PG_VERSION"

    # Get database size
    DB_SIZE=$(docker exec "$SERVICE_NAME" psql -U "$POSTGRES_USER" -c "SELECT pg_size_pretty(pg_database_size('$POSTGRES_DB'));" -t 2>/dev/null | tr -d ' ' || echo "Unknown")
    echo "Database size: $DB_SIZE"

    # Get number of connections
    CONNECTIONS=$(docker exec "$SERVICE_NAME" psql -U "$POSTGRES_USER" -c "SELECT count(*) FROM pg_stat_activity;" -t 2>/dev/null | tr -d ' ' || echo "Unknown")
    echo "Active connections: $CONNECTIONS"
fi

