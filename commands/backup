#!/bin/bash
SERVICE_NAME="$1"

# Source helper functions
source /opt/gokku/scripts/plugin-helpers.sh

# Check if container exists
if ! container_exists "$SERVICE_NAME"; then
    echo "Service '$SERVICE_NAME' not found" >&2
    exit 1
fi

# Check if container is running
if ! container_is_running "$SERVICE_NAME"; then
    echo "Service '$SERVICE_NAME' is not running" >&2
    exit 1
fi

# Get PostgreSQL credentials using jq
SERVICE_CONFIG=$(get_service_config "$SERVICE_NAME")
POSTGRES_USER=$(echo "$SERVICE_CONFIG" | jq -r '.config.user // empty')
POSTGRES_DB=$(echo "$SERVICE_CONFIG" | jq -r '.config.database // empty')

# Dump database to stdout
docker exec "$SERVICE_NAME" pg_dump -U "$POSTGRES_USER" "$POSTGRES_DB"

